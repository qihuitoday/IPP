/*
***************************
*  17k book   javascript  *
*  dependent:             *
*  	  17k.js              *
*  	  17k.header.index.js *
*  	  17k.login.js 		  *
*  version:1.0            *
*  coder:BennyTian        *
*  date:2011/04/18        *
***************************
*/
if (!window.K17) {
	window.K17 = {};
	window.K17.book = {};
} else if (!window.K17.book) {
	window.K17.book = {};
}
window._ = window.K17;

K17.book.params = null;
$(function(){
	if(K17.isUndefined(K17.book.params) || K17.isEmpty(K17.book.params)|| !$.isPlainObject(K17.book.params)){
		alert("script init error. please invoke K17.initParams method...");
	}
	//$.get("/-addToHistroy.action?bookId="+K17.book.params.bookId);
});

K17.book.initParams = function(json){
	if(K17.isUndefined(json) || K17.isEmpty(json)|| !$.isPlainObject(json) || K17.isUndefined(json.bookId) || K17.isUndefined(json.txtZip) ){
		alert("params Error...");
		flag = false;
	}
	K17.book.params = json;
};

K17.book.addBookHistroy = function(bookId,bookName){
	K17.book.createJSONParse("K17.book.addToHistroy("+bookId+",\""+bookName+"\");");
};

K17.book.addToHistroyCookName = "history";
K17.book.addToHistroy = function(bookId,bookName){
	if(K17.isEmpty(bookId) || K17.isEmpty(bookName)){
		alert("params error ...");
		return false;
	}
	
	var history = K17.cookie(K17.book.addToHistroyCookName);
	if(K17.isEmpty(history)){
		history = {"books":[]};
	}else{
		try{
			history = JSON.parse(history);
		}catch(e){
			history = {"books":[]};
		}
	}
	var historyMaxLength = 10;
	if(!K17.isEmpty(history) && history.books.length>0){
		var tmpHistory = [];
		tmpHistory.push({"bookId":bookId,"bookName":bookName,"date":K17.getDate()});
		$.each(history.books,function(i,e){
			if(tmpHistory.length<historyMaxLength){
				if(e.bookId!=bookId){
					tmpHistory.push({"bookId":e.bookId,"bookName":e.bookName,"date":e.date});
				}
			}
		});
		history.books = tmpHistory;
		tmpHistory = "";
	}else{
		history.books.push({"bookId":bookId,"bookName":bookName,"date":K17.getDate()});
	}
	K17.cookie(K17.book.addToHistroyCookName,JSON.stringify(history),{"expires":30,"path":"/","domain":"17k.com"});
};

K17.book.showBooksHistory = function(parentId,size){
	K17.book.createJSONParse("K17.book.getFromHistory(\""+parentId+"\","+size+");");
};

K17.book.getFromHistory = function(parentId,size){
	var history = K17.cookie(K17.book.addToHistroyCookName);
	if(K17.isEmpty(history)){
		history = {"books":[]};
	}else{
		try{
			history = JSON.parse(history);
		}catch(e){
			history = {"books":[]};
		}
	}
	var html = "";
	if(!K17.isEmpty(history) && history.books.length>0){
		$.each(history.books,function(i,e){
			if(i<size && e.bookId!=K17.book.params.bookId){
				html += "<a target=\"_blank\" href=\"/book/"+e.bookId+".html\" title=\""+e.bookName+"\">"+e.bookName + "</a>";
			}
		});
	}
	if(K17.isEmpty(html)){
		html = "木有最近阅读历史.";
	}
	$("#"+parentId).html(html);
};

K17.book.createJSONParse = function(callback){	//麻痹这个方法写得很变态
	try{
		JSON.parse("{}");	//判断JSON对象是否创建成功.
		if(!K17.isEmpty(callback)){
			eval(callback);
		}
	}catch(e){
		var script = document.createElement("script");
	  	script.charset = "utf-8";
	  	script.language = "javascript"; 
		script.type = "text/javascript";
	    script.src = "http://img.17k.com/script/json2.js";
	    document.getElementsByTagName('head')[0].appendChild(script);
	    var interval = null;
	    interval = setInterval(function(){
	    	try{
	    		if(!K17.isEmpty(JSON)){
	    			clearInterval(interval);
	    			if(!K17.isEmpty(callback)){
	    				eval(callback);
	    			}
	    		}
	    	}catch(e){}
	    },100);
	}
};

K17.book.enterBookshelf = function(){
	if(K17.isLogined()){
		window.open("http://user.17k.com/myBookShelf/showshelf.action","_blank");
	}else{
		K17.book.loginForm("K17.book.enterBookshelf();");
	}
};

K17.book.bookshelf = function(){
	if(K17.isLogined()){
		var url="/bookShelf/bookshelf.action";
		$.post(url,{"bookId":K17.book.params.bookId},function(data){
			if(K17.isEmpty(data)){
				return false;
			}
			if (data.status==0){
				_.getJSON("http://passport.17k.com/sns/updateSnsStatus.action",{"bookId":K17.book.params.bookId,"operation":"1"});
				alert("收藏成功！");
			}else if (data.status==1){
				alert("收藏失败。");
			}else if (data.status==2){
				alert("书签加入成功！");
			}else if (data.status==3){
				alert("本书已经收藏过了！");
		    }else{
		    	alert("error...");
		    } 
		},'json');
	}else{
		K17.book.loginForm("K17.book.bookshelf();");
	}
};

K17.book.fullRead = function(){
	if(K17.isLogined()){
		window.open("http://www.17k.com/html/showVolume.htm?bid="+K17.book.params.bookId,'_blank');
	}else{
		K17.book.loginForm("K17.book.fullRead();");
	}
};

K17.book.txtDown = function() {
	if (K17.isLogined()) {
		window.open("http://www.17k.com" + K17.book.params.txtZip,"_blank");
		try{
			_gaq.push(['_trackEvent', 'downloadChapter', 'download', K17.book.params.bookId+""]);
		}catch(e){}
	} else {
		K17.book.loginForm("K17.book.txtDown();");
	}
};

K17.book.continueRead = function(){
	if(K17.isLogined()){
		$.post("/book/continueRead.action",{"bookId":K17.book.params.bookId},function(data){
			if(!K17.isEmpty(data)){
				var bookMarkId = parseInt(data.bookMarkId);
				switch(bookMarkId){
					case -1:
						alert("请先登录!");break;
					case 0:
						K17.dialog("书签","text:很抱歉，您还没有为此书添加书签。<br><br>如何添加书签：在章节阅读页面，点击“加入书签”，即可保存您的阅读记录，点击此按钮直接进入您上次阅读的章节。&nbsp;&nbsp;&nbsp;<a href=\"/list/"+K17.book.params.bookId+".html\">开始阅读>></a>","300px","auto","floatMsg");break;
					default:
						window.location = "/chapter/"+K17.book.params.bookId+"/"+bookMarkId+".html";break;
				}
			}
		},'json');
	}else{
		K17.book.loginForm("K17.book.continueRead();");
	}
};

K17.book.loginForm = function(callback){
	callback = "K17.header.setLoginedUserInfo();"+callback ;
	K17.login.form(callback);
};

K17.book.applyManager = function(){
	if(K17.isLogined()){
		$.post("/book/applayQmainManage.action",{"bookId":K17.book.params.bookId,"random":+new Date()},function(msg){
			if(K17.isEmpty(msg)){
				return false;
			}
			if (msg.state==0){
	 			alert("申请已提交，作者会以小纸条通知您申请结果，您也可以在“个人中心—我的书评—管理员信息”处查询。");
		 	}else if (msg.state==1){
		 		alert("您已经成为管理员了。");
		 	}else if (msg.state==2){
		 		alert("您已经申请过了，请耐心等待作者的审核。");
		 	}else if (msg.state==3){
		 		alert("抱歉，申请名额已满。");
		 	}else if (msg.state==-1){
		 		alert("抱歉，参数错误。");
		 	}
		},'json');
	}else{
		K17.book.loginForm("K17.book.applyManager();");
	}
};

K17.book.quickCommend = function(butId,contentId){
	if(K17.isEmpty(butId)||K17.isEmpty(contentId)){
		alert("params error...");
		return false;
	}
	K17.hover(butId,contentId);
	$("#"+contentId).find("li").live("click",function(){
		$("input[name=title]").val($(this).html());
		$("textarea[name=content]").val($(this).html());
		$("#"+contentId).hide();
	});
};
K17.book.postTalkbar = function(){
	if(K17.isLogined()){
		if(K17.isEmpty($("input[name=title]").val())){
			alert("请输入评论标题.");
			return false;
		}
		if(K17.isEmpty($("textarea[name=content]").val())){
			alert("请输入评论内容.");
			return false;
		}
		return true;
	}else{
		K17.book.loginForm("K17.book.postTalkbar();");
		return false;
	}
};
/*************书评开始**************/
K17.book.talkbarHtml = "<div class=\"pinglun_li\">" +
							"<div class=\"p_t\">"+
								"<strong class=\"c10\"><a target=\"_blank\">title</a></strong>"+
							"</div>"+
							"<div class=\"p_c\">content</div>"+
							"<div class=\"p_b\">"+
								"<span>发表人:<em><a target=\"_blank\"></a></em></span>"+
								"<span>回复人：<em><a target=\"_blank\"></a></em></span>"+
								"<span>回复时间：<em>18:20:20</em></span>"+
								"<span>点击：<em>0</em></span>"+
								"<span>回复：<em>0</em></span>"+
							"</div>"+
						"</div>";

K17.book.jingImg = "<img src=\"http://img.17k.com/images/jingIco.gif\"/>";
K17.book.vipImg = "<img src=\"http://img.17k.com/style/book/ico_vip.gif\" />";
K17.book.topImg = "<img src=\"http://img.17k.com/images/dingIco.png\" />";
K17.book.quickCommendButId = "";
K17.book.loadTalkbar = function(type){
	if(K17.isEmpty(type)){
		alert("params error...");return false;
	}
	var target = "";
	if(type=="all"){
		target = "tab41_div0";
	}else if(type=="prime"){
		target = "tab41_div1";
	}else if(type=="authorreply"){
		target = "tab41_div2";
	}else{
		alert("params error...");return false;
	}
	$.post("/-talkBar.action",{"bookId":K17.book.params.bookId,"type":type,"random":Math.random()},function(data){
		if(K17.isEmpty(data)){
			return false;
		}
		if(data.status==0){
			var messages = data.list;
			if(messages.length<=0){
				$("#"+target).html("");
			}else{
				$.each(messages,function(i,message){
					var html = $(K17.book.talkbarHtml).clone();
					html.find("strong>a").attr("href","http://comment.17k.com/comment/bookComment.action?id="+message.id+"&bookId="+K17.book.params.bookId).html(message.title);
					var maxLength = 240;
					var messageContent = message.content;
					if(messageContent!=null && messageContent.length>=maxLength){
						messageContent = messageContent.substring(0,maxLength) + "...";
					}
					html.find("div[class=p_c]").html(messageContent);
					var span = html.find("span");
					$(span.get(0)).find("a").attr("href","http://user.17k.com/"+message.userid).html(message.nickname);
					$(span.get(1)).find("a").attr("href","http://user.17k.com/"+message.replyid).html(message.replynickname);
					$(span.get(2)).find("em").html(message.replytime);
					$(span.get(3)).find("em").html(message.pv);
					$(span.get(4)).find("em").html(message.replycount);
					if(message.istop=="Y"){
						html.find("strong>a").before(K17.book.topImg);
					}
					if(message.isprime=="Y"){
						html.find("strong>a").before(K17.book.jingImg);
					}
					if (message.postVipIco!=null&&message.postVipIco>0){
				  		//$(span.get(0)).find("a").after(K17.book.vipImg);
				  		$(span.get(0)).find("a").after("<a href=\"http://cms.17k.com/news/1168.html\" target=\"_blank\"><img class=\"vipioc\" style=\"margin-left:4px;margin-top:2px;\" title=\"VIP "+message.postVipIco+"级\" src=\"http://img.17k.com/vip_pic/vip_0"+message.postVipIco+".gif\" /></a>");
				  	}
					if (message.replyVipIco!=null&&message.replyVipIco>0){
				  		//$(span.get(1)).find("a").after(K17.book.vipImg);
				  		$(span.get(1)).find("a").after("<a href=\"http://cms.17k.com/news/1168.html\" target=\"_blank\"><img class=\"vipioc\" style=\"margin-left:4px;margin-top:2px;\" title=\"VIP "+message.replyVipIco+"级\" src=\"http://img.17k.com/vip_pic/vip_0"+message.replyVipIco+".gif\" /></a>");
				  	} 
					$("#"+target).append(html);
				});
			}
			//解决 快速评论 和 ajax冲突产生的错位问题
			$("#"+K17.book.quickCommendButId).parent().append($("#"+K17.book.quickCommendButId));
		}
	},'json');
};

K17.book.initTalkbar = function(quickCommendButId){
	//老书评停用
	return false;
	if(K17.isEmpty(quickCommendButId)){
		alert("params error...");return false;
	}
	K17.book.quickCommendButId = quickCommendButId;
	K17.book.loadTalkbar("all");
	K17.book.loadTalkbar("prime");
	K17.book.loadTalkbar("authorreply");
};
/*************书评结束**************/

/***************投票开始**************/
K17.book.vote = function(voteType,voteSingleType,maxOption,voteId){
	if(K17.isLogined()){
		var type = "checkbox" ;
		if(voteType==voteSingleType){
			type = "radio" ;
		}
		if($(":input[name=voteItems][checked]").length<=0){
			alert("请选择投票项目");return false;
		}
		if("checkbox"==type){
			if($(":input[name=voteItems][checked]").length>maxOption-0){
				alert("该选项最多只能选择"+maxOption+"项,你的选项过多!");return false;
			}
		}
		var voteItems = [];
		if("radio"==type){
			voteItems.push($(":input[name=voteItems][checked]").val());
		}else{
			$.each($(":input[name=voteItems][checked]"),function(i,e){
				voteItems.push(e.value);
			});
		}
		var voteStr = "";
		$.each(voteItems,function(i,e){
			voteStr += e +"_";
		});
		voteStr = voteStr.substring(0,voteStr.length-1);
		var vParams = {"bookId":K17.book.params.bookId,"voteId":voteId,"type":type,"voteItems":voteStr};
		$.post("/book/userVote.action",vParams,function(data){
			if(K17.isEmpty(data)){
				return false;
			}
			var json = eval("("+data+")");
			if(json.result=="true"){
				$("#voteBox").hide();
				$("#voteResultBox").show();
				if(json.message=="恭喜,投票成功!"){
					K17.book.voteCalculateResult(voteItems);
				}
			}
			alert(json.message);
		});
	}else{
		K17.book.loginForm("K17.book.vote();");
	}
};

K17.book.checkMaxOption = function(obj,maxOption){
	if($(":input[name=voteItems][checked]").length>maxOption){
		alert("该选项最多只能选择"+maxOption+"项!");
		obj.checked = false;
	}
};

K17.book.voteCalculateResult = function(selectedVoteItems){
	var voteResultDivs = $("div[id^=voteResult_]");
	var voteAmount = selectedVoteItems.length;
	$.each(voteResultDivs,function(i,e){
		voteAmount+= $(e).find("span").html()-0;
	});
	$.each(voteResultDivs,function(i,e){
		var colorBar = $(e).prev().find("span");
		var voteCount = $(e).find("span").html()-0;
		$.each(selectedVoteItems,function(i,id){
			if(id== $(e).attr("id").replace("voteResult_",'')){
				voteCount += 1;return;
			}
		});
		var rate = parseFloat(voteCount)/parseFloat(voteAmount);
		colorBar.css({width:(rate*100)+"%"});
		$(e).find("span").html(voteCount);
		$(e).find("em").html("("+(Math.round(rate*100))+"%)");
	});
	$("#voteUserAmount").html($("#voteUserAmount").html()-0+1);
};
/***************投票结束**************/

/*******鲜花相关开始******/
K17.book.flowerButId = "";
K17.book.flower = function(id){
	if(K17.isEmpty(id)){
		alert("params error...");return false;
	}
	K17.book.flowerButId = id;
	if(K17.isLogined()){
		K17.loadStyle("propDialogContent","http://img.17k.com/prop/popup.css",function(){
			var url = "/htmls-prop.action?bookId="+K17.book.params.bookId+"&type=flower&r="+K17.random(0,10000);
			K17.newdialog('投票支持啦','url:'+url,670,440);
		});
	}else{
		K17.book.loginForm("K17.book.flower('"+id+"');");
	}
};

K17.book.flowerSubmit = function(count){
	$.post("/book/flower.action",{"count":count,"bookId":K17.book.params.bookId},function(msg){
		if(K17.isEmpty(msg)){
			return false;
		}
		if (msg.status==0){
			if(!K17.isEmpty(K17.book.flowerButId) && K17.isNumber($("#"+K17.book.flowerButId).html())){
				$("#"+K17.book.flowerButId).html(msg.acount);
			}
			flowerCallback(true,"送鲜花成功，非常感谢您的支持！");
			clearLocalStorage(2);
			var num = K17.cookie("tfn");
			if(!K17.isEmpty(num)){
				$("#top #flower").html(num); //重新设置头里面的鲜花数量
			}
		}else if(msg.status==1){
			switch(msg.info){
				case 1:
					flowerCallback(false,"参数不正确。");
					break;
				case 2:
					flowerCallback(false,"服务器忙,请稍后再试...");
		 			break;
				case 3:
					flowerCallback(false,"服务器忙,请稍后再试...");
	   	 			break;
	   	 		case 4:
	   	 			flowerCallback(false,"服务器忙,请稍后再试...");
	   	 			break;
	   	 		case 5:
					flowerCallback(false,"当日鲜花票已经用完。");
	   	 			break;	
	   	 		case 6:
					flowerCallback(false,"对不起，您因违规操作，已被禁止投送鲜花。");
	   	 			break;	
			}
		}
	},'json');
};
/**************鲜花相关结束***********/

/*************贵宾开始************/
K17.book.vipVoteButId = "";
K17.book.vipVote = function(id){
	if(K17.isEmpty(id)){
		alert("params error...");return false;
	}
	K17.book.vipVoteButId = id;
	if(K17.isLogined()){
		K17.loadStyle("propDialogContent","http://img.17k.com/prop/popup.css",function(){
			var url = "/htmls-prop.action?bookId="+K17.book.params.bookId+"&type=gb&r="+K17.random(0,10000);
			K17.newdialog('投票支持啦','url:'+url,670,440);
		});
	}else{
		K17.book.loginForm("K17.book.vipVote('"+id+"');");
	}
};

K17.book.vipVoteSubmit = function(count){
	$.post("/book/charge.action",{"count":count,"bookId":K17.book.params.bookId},function(msg){
		if(K17.isEmpty(msg)){
			return false;
		}
		if(msg.status==0){
			if(!K17.isEmpty(K17.book.vipVoteButId) && K17.isNumber($("#"+K17.book.vipVoteButId).html())){
				$("#"+K17.book.vipVoteButId).html(msg.acount);
			}
	 		clearLocalStorage(0);
	 		vipVoteCallback(true,"投贵宾成功，非常感谢您的支持！");
	 	}else if(msg.status==1){
	 		switch(msg.info){
	 			case 1:
	 				vipVoteCallback(false,"参数不正确。");
	 				break;
	 			case 2:
	 				vipVoteCallback(false,"您的余额不够，先去充值吧！");
	 				break;
	 			case 3:
	 				vipVoteCallback(false,"您的余额不够，先去充值吧！");
	 				break;
	 			case 4:
	 				flowerCallback(false,"服务器忙,请稍后再试...");
	 				break;
	 			case 5:
	 				vipVoteCallback(false,"当日贵宾票已经用完。");
	 				break;
	 		}
	 	}
	},'json');
};
/*************贵宾结束************/

/**************PK票开始************/
K17.book.pkVoteButId = "";
K17.book.pkVote = function(id){
	if(K17.isEmpty(id)){
		alert("params error...");return false;
	}
	K17.book.pkVoteButId = id;
	if(K17.isLogined()){
		K17.loadStyle("propDialogContent","http://img.17k.com/prop/popup.css",function(){
			var url = "/htmls-prop.action?bookId="+K17.book.params.bookId+"&type=pk&r="+K17.random(0,10000);
			K17.newdialog('投票支持啦','url:'+url,670,440);
		});
	}else{
		K17.book.loginForm("K17.book.pkVote('"+id+"');");
	}
};

K17.book.pkVoteSubmit = function(count){
	$.post("/book/vote.action",{"count":count,"bookId":K17.book.params.bookId},function(data){
		if(K17.isEmpty(data)){
			return false;
		}else if(data.result){
			if( !K17.isEmpty(K17.book.pkVoteButId) && K17.isNumber($("#"+K17.book.pkVoteButId).html())){
				$("#"+K17.book.pkVoteButId).html(data.acount);
				$("#"+K17.book.pkVoteButId).attr("title",data.title.replace("&amp;","&"));
			}
			var num =K17.cookie("month_pk_count");
			if (!K17.isEmpty(num)){
				$("#top #pkVote").html(num); //重新设置头里面的PK票数量
			}
			clearLocalStorage(1);
			pkVoteCallback(true,"投票成功，非常感谢您的支持！");
		}else{
			pkVoteCallback(false,data.message);
		}
	},'json');
};
/**************PK票结束************/

/***************盖章开始************/

K17.book.printMarkButId = "";
K17.book.printMarkTargetId = "";
K17.book.bookMarks = null;
//千元大章对应封面上方提示限10个字
K17.book.printMarkMaxTilte={
		"1":"鉴定此书必须要读！",
		"2":"吐血三升，力荐此书！",
		"3":"此书有毒，急求神农！",
		"6":"此书神作，谁与争锋！",
		"5":"光速更新，应接不暇！",
		"8":"此书还能更坑爹吗？",
		"7":"此书更新还能更慢吗？",
		"9":"妹子能顶半边天",
		"10":"码字植树致富一条龙",
		"12":"爱的机票跟我回家过年",
		"11":"千金一掷，推出冠军",
		"13":"新春快乐 火爆一整年" ,
		"14":"千金红包 博君一笑",
		"15":"福来到 报春晓！",
		"16":"快到我碗里来",
		"17":"花灯锦绣 同庆佳节"
};


K17.book.getBookMarks = function(panelId,butId){
	if(K17.isEmpty(panelId) || K17.isEmpty(butId) ){
		alert("params error...");return false;
	}
	K17.book.printMarkTargetId = panelId;
	K17.book.printMarkButId = butId;
	$.post("/book/getBookMarks.action",{"bookId":K17.book.params.bookId},function(data){
		if(K17.isEmpty(data)){
			return false;
		}
		var marks = data.result;
		var maxTop = 230;var minTop = 0;var maxLeft = 160;var minLeft = 0;
		if(!K17.isEmpty(marks) && marks.length>0){
			K17.book.bookMarks = marks;
			$("#"+panelId).html("");
			var max_title_content = null;
			var max_title_type = null;
			var max_title_userId=null;
			var tmpMarks = [];
			var maxDisplayCount = 100;
			if(marks.length>maxDisplayCount){
				var k = marks.length-maxDisplayCount;
				for(var x=k;x<marks.length;x++){
					tmpMarks.push(marks[x]);
				}
			}else{
				tmpMarks = marks;
			}
			$.each(marks,function(i,mark){
				var x = mark.x-0;	var y = mark.y-0;
				x=x>maxLeft?maxLeft:x;	x=x<minLeft?minLeft:x;
				y=y>maxTop?maxTop:y;	y=y<minTop?minTop:y;
				var str = "<small style=\"left:"+x+"px;top:"+y+"px;\" title=\""+decodeURI(mark.content)+"认证\" class=\"stamp"+mark.type+" size"+mark.size+"\"></small>";
				$("#"+panelId).append(str);
				if($("#"+panelId+"_Title").length>0&&mark.size==250){
					max_title_content=null;
					max_title_type =null;
					max_title_userId =null;
					max_title_content=mark.content;
					max_title_type=mark.type;
					max_title_userId = mark.userId;
				}
			}); 
			
			//千元大章封面上方提示操作
			if($("#"+panelId+"_Title").length>0&&max_title_content!=null&&max_title_type!=null&&max_title_userId!=null){
				var title_str = "<p>"+decodeURI(max_title_content)+"<br />"+K17.book.printMarkMaxTilte[max_title_type]+"</p>";
				$("#"+panelId+"_Title").removeClass();
				$("#"+panelId+"_Title").addClass("maxgz-tip maxgz-tip"+max_title_type);
				$("#"+panelId+"_Title").html(title_str);
				}
		}
		$("#"+butId).html(data.total);
	},'json');
};


K17.book.printMark = function(panelId,butId){
	if(K17.isEmpty(panelId) || K17.isEmpty(butId) ){
		alert("params error...");return false;
	}
	if(K17.isLogined()){
		K17.loadStyle("propDialogContent","http://img.17k.com/prop/popup.css?r="+Math.random(),function(){
			var url = "/htmls-prop.action?bookId="+K17.book.params.bookId+"&type=pm&r="+K17.random(0,10000);
			K17.newdialog('投票支持啦','url:'+url,670,440);
		});
	}else{
		K17.book.loginForm("K17.book.printMark('"+panelId+"','"+butId+"');");
	}
};

K17.book.printMarkSubmit = function(x,y,type,size){
	if(K17.isEmpty(x) || K17.isEmpty(y) || K17.isEmpty(type)){
		alert("params error...");return false;
	}
	$.post("/book/printMark.action",{"x":parseInt(x),"y":parseInt(y),"type":type,"bookId":K17.book.params.bookId,"size":size},function(data){
		if(K17.isEmpty(data)){
			return false;
		}
		if(data.result){
			clearLocalStorage(3);
			K17.book.getBookMarks(K17.book.printMarkTargetId,K17.book.printMarkButId);
		}
		printMarkCallBack(data.result,data.message);	//这个方法写在了printMark.jsp里
	},'json');
};

/***************盖章结束************/

/***********分享按钮************/
K17.book.share = function(bookName,chapterName){
	var local = encodeURIComponent(window.location);
	$("#ckepop a").live("click",function(){
		var title = "阅读一本很不错的小说《"+bookName+"》，最新章节《"+chapterName+"》很喜欢,分享给大家，阅读地址：";
		var webid = $(this).attr("class").replace("jiathis_button_","");
		if(webid=="tsina"){
			title = "我正在 @17k小说网-官方 " + title;
		}else if(webid=="tqq"){
			title = "我正在 @yiqikan17k " + title;
		}else{
			title = "我正在17K小说网(http://www.17k.com)" + title;
		}
		title = encodeURIComponent(title);
		var url = "http://www.jiathis.com/send/?webid="+ webid + "&url="+local + "&title="+title+"&uid=1511703";
		window.open(url,"_blank");
	});
};

K17.book.alphaPrintMark = function(){
	var rslt = navigator.appVersion.match(/MSIE (\d+\.\d+)/, '');
	var itsAllGood = (rslt != null && Number(rslt[1]) >= 5.5);
	if (itsAllGood) {
		var printMark = $("#printMarkBox small");
		if(printMark.length>0){
			$.each(printMark,function(i,e){
				var bg = e.currentStyle.backgroundImage;
				if (bg){
					if (bg.match(/.png/i) != null){
						var mypng = bg.substring(5,bg.length-2);
						e.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+mypng+"', sizingMethod='crop')";
						e.style.backgroundImage = "url('')";
					}
				}
			});
		}
	};
};

/**
 * clear local storage .  added By LiuYang
 */
function clearLocalStorage(type){
	try{
		//actionId GB=0,PK=1,XH=2,GZ=3,默认贵宾
		var local_key='new.py.msg.';
		var actionId = type;
		var key = local_key+K17.book.params.bookId+"."+actionId;
		var key2 = local_key+K17.book.params.bookId+".scrollInfo";
		if (window.localStorage){
			K17.html5.removeInLocal(key);
			K17.html5.removeInLocal(key2);
		}
	}catch(e){}
}

K17.book.chapterVote = function(elementId,chapterId,type){
	$.post("/book/saveBookchapterVote.action",{"chapterId":chapterId,"type":type},function(data){
		if(data.result){
			$("#"+elementId).html(parseInt($("#"+elementId).html())+1);
			if(type==0){	//top
				K17.showTipsAnimation(elementId,"+1");
			}else{
				K17.showTipsAnimation(elementId,"+1");
			}
		}else{
			$("#likeTips").html(data.message);
			$("#likeTips").css({"visibility":"visible"});
			setTimeout(function(){$("#likeTips").css({"visibility":"hidden"});}, 2*1000);
		}
	},'json');
};