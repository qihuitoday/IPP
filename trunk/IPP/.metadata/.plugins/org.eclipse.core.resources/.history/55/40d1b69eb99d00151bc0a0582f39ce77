     
//验证码索引
var codeIndex = 0;
//错误信息
var errorMsg = "";
//是否加载图片
var IsCodeImageLoad = true;
	 
$(function() {
    //初始化头部样式
    iniHead();
    //事件加载
    eventLoadLogin();
    //给与焦点
    setFocus("txtInputName");
	    //加载验证码
	    doValidateCodeImageLoad();
	    var showQq = getParm("hideqq");
    if( showQq !=1 ){
      $("#btnQqShareLogin").show();
    }
});

//事件加载
function eventLoadLogin() {
	  /*
	 var varUserValidFlag = userValid();
	 if(varUserValidFlag != null && varUserValidFlag != ""){
		window.location.href = baseLocation;
		return false;
	 }
		*/
	
	//登录用户
	getObj("btnLoginUser").click(function() {
		ckForm() ? formSubmit() : false;
	});
	
	//找回密码
	getObj("aGetPass").click(function() {
		window.location = baseLocation + "find_pw.html";
	});
	
	//更换 验证码图片
	getObj("reset_image").click(function(){
		doValidateCodeImageLoad();	//加载验证码图片
		return false;
	});
	
	//给内容区域注册 回车事件
	$("body").keypress(function(event) {
		var keycode = event.which;
		if (keycode == 13) {
			ckForm() ? formSubmit() : false;
		}
	});
}
	  
//验证码Pictrue加载
function doValidateCodeImageLoad(){
	if(IsCodeImageLoad == false){
		return false;
	}
	IsCodeImageLoad = false;
  	var varUrl = baseCGI+"getcheckimage.cgi";
	$.post(varUrl,function(data){
		codeIndex = $(data).find("result").text();
		var varImagePath = "code/" + codeIndex +".jpg";
		getObj("check_image > img").attr("src",varImagePath);
		IsCodeImageLoad = true;
	});		
}

function checkSuccess() {
	var loginFlag = $.cookie("loginFlag");
	if (loginFlag != null && loginFlag == "false" ) {
		errorMsg = "帐户或密码错误！";
		setFocus("txtInputName");
		$.cookie("loginFlag", "");
		alert(errorMsg);
	}
}

//表单提交
function formSubmit() {
    getObj("btnLoginUser").attr("disabled", "disabled"); //禁用按钮
    //window.location.href = baseLocation + "login";
    document.forms[0].action = "login";
	document.forms[0].submit();
}
/*
function formSubmit() {
    getObj("btnLoginUser").attr("disabled", "disabled"); //禁用按钮
    //get loginForm 
    var username = $.trim($("#txtInputName").val());
    var password = $("#txtInputPassword").val();        
    var check_code = $("#textValidateCode").val();        
    password = hex_md5(password);        
    password = password.toUpperCase();
    var loginForm = "check_code="+check_code+"&name="+username+"&password="+password+"&check_image="+codeIndex;				//序列化表单
    var varUrl = baseCGI + "login.cgi";
    $.post(varUrl, loginForm, function(data) {
      getObj("btnLoginUser").removeAttr("disabled"); //启用按钮
      var varRessult = $(data).find("result").text();
      if (varRessult == 0) {
		var vip = $.cookie("vip_leshuake");
		  if(vip && vip == "true_"+$.cookie("name")){
			 window.location.href = baseLocation+"my_leshua.html";
			 return;
		  }
        var returnUrl = getReturnUrl();
        if(returnUrl!=''){
            window.location.href = returnUrl;
        } else {
          window.location.href = baseLocation;
        }
      }
      else {
		  if(varRessult == -2){
			errorMsg = "验证码错误";
			setFocus("textValidateCode");
		  }else{
			errorMsg = "帐户或密码错误";
			setFocus("txtInputName");
		  }
		  alert(errorMsg);
      }
    }); //end for										
}
*/

//检测表单
function ckForm() {
	var _ck_number = 0;
    var varName = getObj("txtInputName");
	var varUserNameMsg = $("#userNameMsg");
    if (!checkUserName(varName.val())) {
    	//varName.focus();
    	//varName.select();
	  	varUserNameMsg.html("帐户格式错误！");
	  	varUserNameMsg.attr("class","red_font");
    }else{
    	_ck_number++;
    	varUserNameMsg.html("");
    	varUserNameMsg.attr("class","green_font");
	}
    var varPassword = getObj("txtInputPassword");
	var varPassMsg = $("#passwordMsg");
    if (!checkPassword(varPassword.val())) {
    	//varPassword.focus();
    	//varPassword.select();
    	varPassMsg.attr("class","red_font");
    	varPassMsg.html("密码格式错误！");
    }else{
    	_ck_number++;
    	varPassMsg.html("");
    	varPassMsg.attr("class","green_font");
	}
	/*
	var varCode = getObj("textValidateCode");
	if(!isCode(varCode.val())){
		//varCode.focus();
		$("#spanCodeMsg").attr("class","red_font");					
		$("#spanCodeMsg").html("请输入验证码");
	}else{
		_ck_number++;
		$("#spanCodeMsg").html("");
		$("#spanCodeMsg").attr("class","green_font");
	}*/
	if( _ck_number == 2){
		return true;
	}else{
		return false;
	}
	return false;
}

//效验帐户：只能输入6-32位字母、数字、下划线
function checkUserName(username) {
	username = strTrim(username);
	var patrn = /^(\w){6,32}$/;
	if (!patrn.exec(username)) {
		return false;
	}
	return true;
}

//校验密码：只能输入6-32位字母、数字、下划线
function checkPassword(pass) {
    pass = strTrim(pass);
    var patrn = /^(\w){6,32}$/;
    if (!patrn.exec(pass)) {
      return false;
    }
    return true;
}
	  
//检测验证码
function isCode(code) {        
	var patrn = /^(\w){4}$/;
	if (!patrn.exec(code)) {
	  return false;
	}       
	return true;
}